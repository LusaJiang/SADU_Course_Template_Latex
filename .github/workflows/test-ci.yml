name: Test CI

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-build:
    name: Test LaTeX Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install MiKTeX
        run: |
          # Import GPG key for MiKTeX repository
          curl -fsSL https://miktex.org/download/key | sudo gpg --dearmor -o /usr/share/keyrings/miktex.gpg
          
          # Add MiKTeX repository (Ubuntu 24.04/noble)
          echo "deb [signed-by=/usr/share/keyrings/miktex.gpg] https://miktex.org/download/ubuntu noble universe" | sudo tee /etc/apt/sources.list.d/miktex.list
          
          # Update package list and install MiKTeX
          sudo apt-get update
          sudo apt-get install -y miktex
          
          # Complete private installation
          miktexsetup finish
          
          # Enable automatic package installation
          initexmf --set-config-value [MPM]AutoInstall=1
          
          # Update package database
          miktex packages update
          
          # Comprehensive PATH configuration
          echo "=== Finding MiKTeX installation paths ==="
          find / -name "*miktex*" -type d 2>/dev/null | grep -E "(bin|exec)" | head -20
          echo "=== Finding xelatex executable ==="
          find / -name "xelatex" 2>/dev/null
          
          # Try to locate miktex console to infer binary location
          MIKTEX_CONSOLE=$(find / -name "miktex-console" 2>/dev/null | head -1)
          if [ -n "$MIKTEX_CONSOLE" ]; then
            echo "Found miktex-console at: $MIKTEX_CONSOLE"
            MIKTEX_BIN_DIR=$(dirname "$MIKTEX_CONSOLE")
            echo "Inferred bin directory: $MIKTEX_BIN_DIR"
          fi
          
          # Common MiKTeX binary paths
          COMMON_PATHS="/usr/bin:/usr/local/bin:/opt/miktex/bin:/opt/miktex/bin/x64:/opt/miktex/bin/x86_64-linux:/home/runner/.miktex/bin:/home/runner/.miktex/bin/x64"
          
          # Add to GitHub PATH for subsequent steps
          echo "$COMMON_PATHS" >> $GITHUB_PATH
          
          # Export for current session
          export PATH="$COMMON_PATHS:$PATH"
          
          echo "=== Current PATH ==="
          echo "$PATH"
          
          echo "=== Testing miktex command ==="
          miktex --version || echo "miktex command not found"
          
          echo "=== Trying to find and test xelatex ==="
          # Try different ways to locate xelatex
          for path in $COMMON_PATHS; do
            if [ -d "$path" ] && [ -x "$path/xelatex" ]; then
              echo "Found xelatex at: $path/xelatex"
              "$path/xelatex" --version
              # Create symlink in /usr/local/bin if not exists
              if [ ! -f /usr/local/bin/xelatex ]; then
                sudo ln -s "$path/xelatex" /usr/local/bin/xelatex
                echo "Created symlink /usr/local/bin/xelatex"
              fi
              break
            fi
          done

      - name: Install Chinese font support
        run: |
          # Ensure PATH is set
          export PATH="/usr/bin:/usr/local/bin:/opt/miktex/bin:/opt/miktex/bin/x64:/opt/miktex/bin/x86_64-linux:/home/runner/.miktex/bin:/home/runner/.miktex/bin/x64:$PATH"
          
          # Install Fandol fonts for Chinese support
          sudo apt-get install -y fonts-noto-cjk
          
          # Install additional packages for CJK support
          echo "Installing CJK packages..."
          miktex packages install ctex fontspec xecjk fandol || echo "Package installation may have issues"
          
          # Verify xelatex is available
          echo "Testing xelatex availability..."
          xelatex --version || echo "xelatex still not found"
          
          # If xelatex not found, try direct path execution
          echo "Trying alternative xelatex locations..."
          find /opt /home -name "xelatex" -executable 2>/dev/null | while read -r exe; do
            echo "Testing: $exe"
            "$exe" --version 2>/dev/null && echo "SUCCESS: $exe works" && break
          done

      - name: Compile LaTeX document
        id: compile
        continue-on-error: true
        run: |
          # Clean previous compilation files
          rm -f *.pdf *.aux *.log *.toc *.bbl *.blg *.out *.lof *.lot
          
          # Compile the document with XeLaTeX
          echo "Compiling with xelatex..."
          xelatex main.tex
          
          # Run BibTeX if .bib file exists
          if [ -f reference.bib ]; then
            echo "Running bibtex..."
            bibtex main.aux || echo "BibTeX failed, continuing..."
          fi
          
          # Second compilation for cross-references
          echo "Second xelatex compilation..."
          xelatex main.tex
          
          # Third compilation for final formatting
          echo "Final xelatex compilation..."
          xelatex main.tex
          
          # Check if PDF was generated successfully
          if [ -f main.pdf ]; then
            echo "PDF generated successfully"
            echo "compilation_success=true" >> $GITHUB_OUTPUT
          else
            echo "PDF generation failed"
            echo "compilation_success=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload PDF artifact
        if: steps.compile.outputs.compilation_success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: compiled-pdf-${{ github.run_number }}
          path: main.pdf
          retention-days: 30

      - name: Upload compilation logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compilation-logs-${{ github.run_number }}
          path: |
            *.aux
            *.log
            *.toc
            *.bbl
            *.blg
            *.out
            *.lof
            *.lot
          retention-days: 7

      - name: Display compilation summary
        if: always()
        run: |
          echo "=== Compilation Summary ==="
          echo "PDF exists: $([ -f main.pdf ] && echo 'Yes' || echo 'No')"
          echo "Compilation success flag: ${{ steps.compile.outputs.compilation_success }}"
          echo "Working directory contents:"
          ls -la
          
          # Show log file if it exists
          if [ -f main.log ]; then
            echo ""
            echo "=== Last 50 lines of main.log ==="
            tail -50 main.log
          fi

      - name: Fail job if compilation unsuccessful
        if: steps.compile.outputs.compilation_success != 'true'
        run: |
          echo "‚ùå LaTeX compilation failed"
          echo "Check the uploaded logs for detailed error information"
          exit 1