name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-release:
    name: Build and Release PDF
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install MiKTeX
        run: |
          # Import GPG key for MiKTeX repository
          curl -fsSL https://miktex.org/download/key | sudo gpg --dearmor -o /usr/share/keyrings/miktex.gpg
          
          # Add MiKTeX repository (Ubuntu 24.04/noble)
          echo "deb [signed-by=/usr/share/keyrings/miktex.gpg] https://miktex.org/download/ubuntu noble universe" | sudo tee /etc/apt/sources.list.d/miktex.list
          
          # Update package list and install MiKTeX
          sudo apt-get update
          sudo apt-get install -y miktex
          
          # Complete private installation
          miktexsetup finish
          
          # Enable automatic package installation
          initexmf --set-config-value [MPM]AutoInstall=1
          
          # Update package database
          miktex packages update
          
          # Add MiKTeX to PATH (try multiple locations)
          MIKTEX_PATHS="/home/runner/.miktex/bin/x64:/opt/miktex/bin/x64:/usr/local/bin"
          echo "$MIKTEX_PATHS" >> $GITHUB_PATH
          
          # Also export for current session
          export PATH="$MIKTEX_PATHS:$PATH"
          
          # Verify installation and find xelatex
          echo "Verifying MiKTeX installation..."
          miktex --version
          echo "Searching for xelatex..."
          find / -name "xelatex" 2>/dev/null | head -10
          which xelatex || echo "xelatex still not found"

      - name: Install Chinese font support
        run: |
          # Refresh PATH for this step
          export PATH="/home/runner/.miktex/bin/x64:/opt/miktex/bin/x64:/usr/local/bin:$PATH"
          
          # Install Fandol fonts for Chinese support
          sudo apt-get install -y fonts-noto-cjk
          
          # Install additional packages for CJK support
          miktex packages install ctex fontspec xecjk fandol
          
          # Verify xelatex is available
          echo "Testing xelatex availability..."
          xelatex --version

      - name: Compile LaTeX document
        id: compile
        continue-on-error: true
        run: |
          # Clean previous compilation files
          rm -f *.pdf *.aux *.log *.toc *.bbl *.blg *.out *.lof *.lot
          
          # Compile the document with XeLaTeX
          echo "Compiling with xelatex..."
          xelatex main.tex
          
          # Run BibTeX if .bib file exists
          if [ -f reference.bib ]; then
            echo "Running bibtex..."
            bibtex main.aux || echo "BibTeX failed, continuing..."
          fi
          
          # Second compilation for cross-references
          echo "Second xelatex compilation..."
          xelatex main.tex
          
          # Third compilation for final formatting
          echo "Final xelatex compilation..."
          xelatex main.tex
          
          # Check if PDF was generated successfully
          if [ -f main.pdf ]; then
            echo "PDF generated successfully"
            echo "compilation_success=true" >> $GITHUB_OUTPUT
          else
            echo "PDF generation failed"
            echo "compilation_success=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload compilation logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compilation-logs-${{ github.run_number }}
          path: |
            *.aux
            *.log
            *.toc
            *.bbl
            *.blg
            *.out
            *.lof
            *.lot
          retention-days: 7

      - name: Rename PDF with version
        if: ${{ steps.compile.outputs.compilation_success == 'true' }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          mv main.pdf "å±±ä¸œå†œä¸šå¤§å­¦è¯¾ç¨‹æŠ¥å‘Š_${VERSION}.pdf"

      - name: Create Release
        if: ${{ steps.compile.outputs.compilation_success == 'true' }}
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          body: |
            ## ğŸ“ å±±ä¸œå†œä¸šå¤§å­¦è¯¾ç¨‹æŠ¥å‘Š
            
            è‡ªåŠ¨ç”Ÿæˆçš„PDFæ–‡æ¡£
            
            - ç¼–è¯‘ç¯å¢ƒ: MiKTeX + CJKæ”¯æŒ
            - ç¼–è¯‘æ—¶é—´: $(date -u)

      - name: Upload PDF to Release
        if: ${{ steps.compile.outputs.compilation_success == 'true' }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./å±±ä¸œå†œä¸šå¤§å­¦è¯¾ç¨‹æŠ¥å‘Š_${{ github.ref_name }}.pdf
          asset_name: å±±ä¸œå†œä¸šå¤§å­¦è¯¾ç¨‹æŠ¥å‘Š_${{ github.ref_name }}.pdf
          asset_content_type: application/pdf

      - name: Display compilation summary
        if: always()
        run: |
          echo "=== Release Compilation Summary ==="
          echo "Tag: ${{ github.ref_name }}"
          echo "PDF exists: $([ -f main.pdf ] && echo 'Yes' || echo 'No')"
          echo "Compilation success: ${{ steps.compile.outputs.compilation_success }}"
          echo "Working directory contents:"
          ls -la
          
          # Show log file if it exists
          if [ -f main.log ]; then
            echo ""
            echo "=== Last 50 lines of main.log ==="
            tail -50 main.log
          fi

      - name: Report compilation failure
        if: ${{ steps.compile.outputs.compilation_success != 'true' }}
        run: |
          echo "âŒ LaTeX compilation failed for release"
          echo "Check the uploaded logs for detailed error information"
          exit 1